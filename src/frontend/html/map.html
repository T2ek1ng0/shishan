<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ËßÇÈ∏üÂú∞Âõæ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* Override common.css for full screen map */
        body {
            padding: 0 !important;
            display: block !important;
            margin: 0 !important;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        #map { height: 100%; width: 100%; background-color: #f0f0f0; z-index: 1; }
        
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }
        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 200px !important;
        }
        .popup-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .popup-info {
            padding: 10px;
        }
        .popup-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .popup-desc {
            font-size: 12px;
            color: #666;
        }
        
        #add-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        #add-btn:hover { background: #2980b9; }

        /* Records List Button */
        #list-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            border: none;
        }
        #list-btn:hover { background: #f9f9f9; }

        /* Records List Overlay */
        #records-list-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1500;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .list-search-bar {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #list-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }
        
        .record-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            gap: 15px;
            cursor: pointer;
            transition: box-shadow 0.2s;
            width: 100%;
            box-sizing: border-box;
            align-items: center;
            background: white;
        }
        .record-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: #f9f9f9;
        }
        .record-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .record-card-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .record-card-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }
        .record-card-desc {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .detail-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        .detail-actions button {
            flex: 1;
            padding: 10px 0;
            text-align: center;
        }

        /* ÁÆÄÂçïÁöÑÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .btn-group { text-align: right; margin-top: 20px; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; }
        .btn-cancel { background: #e0e0e0; margin-right: 10px; }
        .btn-save { background: #3498db; color: white; }

        /* Detail Modal */
        #detail-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2100;
            align-items: center;
            justify-content: center;
        }
        .detail-content {
            background: white;
            padding: 0;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .detail-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #eee;
        }
        .detail-info {
            padding: 20px;
        }
        .detail-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .detail-desc {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .detail-meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 20px;
        }
        .detail-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Social Features Styles */
        .avatar-small { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 5px; }
        .user-tag { font-size: 12px; color: #666; display: flex; align-items: center; margin-top: 5px; }
        
        .gallery-container { display: flex; gap: 5px; overflow-x: auto; padding: 10px 0; }
        .gallery-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .gallery-thumb:hover { border-color: #3498db; }
        
        .comments-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; max-height: 150px; overflow-y: auto; }
        .comment-item { margin-bottom: 10px; font-size: 13px; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px; }
        .comment-user { font-weight: bold; color: #2c3e50; }
        .comment-content { color: #555; margin-left: 5px; display: block; margin-top: 2px; }
        .comment-time { font-size: 11px; color: #999; float: right; }
        
        .interaction-bar { display: flex; align-items: center; gap: 15px; margin: 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .like-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; color: #888; font-size: 14px; border: 1px solid #ddd; padding: 5px 10px; border-radius: 15px; }
        .like-btn.liked { color: #e74c3c; border-color: #e74c3c; background: #fff0f0; }
        
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
    </style>
</head>
<body>

<button id="list-btn" onclick="showRecordsList()">üìã ËÆ∞ÂΩïÂàóË°®</button>

<div id="records-list-container">
    <div class="list-header">
        <button onclick="hideRecordsList()" style="background:transparent; color:#333; font-size:24px; padding:0;">‚Üê</button>
        <div class="list-search-bar">
            <input type="text" id="list-search-input" placeholder="ÊêúÁ¥¢ËÆ∞ÂΩï..." oninput="filterList()">
        </div>
        <div style="width: 24px;"></div>
    </div>
    <div id="list-content"></div>
</div>

<div id="map"></div>
<button id="add-btn" onclick="startAddingMode()" title="Ê∑ªÂä†ËÆ∞ÂΩï">+</button>

<!-- Add Record Modal -->
<div id="modal">
    <div class="modal-content">
        <h3>Ê∑ªÂä†ËßÇÈ∏üËÆ∞ÂΩï</h3>
        <div class="form-group">
            <label>È∏üÂêç/Ê†áÈ¢ò</label>
            <input type="text" id="record-title" placeholder="‰æãÂ¶ÇÔºöÁ∫¢Âò¥È∏•">
        </div>
        <div class="form-group">
            <label>ÊèèËø∞</label>
            <textarea id="record-desc" rows="3" placeholder="ÊèèËø∞‰∏Ä‰∏ãÂΩìÊó∂ÁöÑÂú∫ÊôØ..."></textarea>
        </div>
        <div class="form-group">
            <label>ÂõæÁâá (ÊîØÊåÅÂ§öÈÄâ)</label>
            <div style="display:flex; gap:5px; flex-direction: column;">
                <button type="button" onclick="selectImage()" style="width:100%; background:#eee; color:#333;">ÈÄâÊã©ÂõæÁâá...</button>
                <div id="image-preview" style="display:flex; gap:5px; overflow-x:auto; height:60px; align-items:center; border:1px dashed #ddd; padding:5px;">
                    <span style="color:#999;font-size:12px;">Êú™ÈÄâÊã©ÂõæÁâá</span>
                </div>
                <input type="hidden" id="record-img"> <!-- Legacy hidden input -->
            </div>
        </div>
        <div class="btn-group">
            <button class="btn-cancel" onclick="closeModal()">ÂèñÊ∂à</button>
            <button class="btn-save" onclick="saveRecord()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- Detail View Modal -->
<div id="detail-modal">
    <div class="detail-content" style="max-height: 90vh; overflow-y: auto;">
        <img id="detail-img" class="detail-img" src="" style="cursor: zoom-in;">
        <div class="detail-info">
            <div id="detail-title" class="detail-title"></div>
            <div id="detail-user" style="margin-bottom: 10px;"></div>
            
            <div id="detail-gallery" class="gallery-container"></div>
            
            <div id="detail-meta" class="detail-meta"></div>
            <div id="detail-desc" class="detail-desc" style="max-height: 100px;"></div>
            
            <div class="interaction-bar">
                <div id="like-btn" class="like-btn">ü§ç ÁÇπËµû</div>
                <span id="like-count" style="font-size: 14px; color: #666;">0</span>
            </div>
            
            <div class="comments-section">
                <div style="font-weight:bold; margin-bottom:10px;">ËØÑËÆ∫</div>
                <div id="comments-list"></div>
                <div style="display:flex; margin-top:10px; gap:5px;">
                    <input type="text" id="comment-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..." style="flex:1; font-size:13px;">
                    <button onclick="addComment()" style="padding:5px 10px; font-size:13px; background:#3498db; color:white;">ÂèëÈÄÅ</button>
                </div>
            </div>

            <div class="detail-actions" style="margin-top: 20px;">
                <button class="btn-save" onclick="locateRecord()">ÂÆö‰Ωç</button>
                <button id="btn-edit" class="btn-cancel" onclick="editMapRecord()" style="background:#f39c12;color:white;display:none;">ÁºñËæë</button>
                <button id="btn-delete" class="btn-cancel" onclick="deleteMapRecord()" style="background:#e74c3c;color:white;display:none;">Âà†Èô§</button>
                <button class="btn-cancel" onclick="closeDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()">
    <img src="">
</div>

<script>
    // ... existing code ...
    
    async function deleteMapRecord() {
        if (!currentDetailRecord) return;
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) return;
        
        try {
            // Find index in allRecords
            const index = allRecords.findIndex(r => r.id === currentDetailRecord.id);
            await ipcRenderer.invoke('delete_map_record', { 
                id: currentDetailRecord.id, 
                index: index 
            });
            
            closeDetailModal();
            loadMapRecords(); // Reload all
        } catch (e) {
            alert('Âà†Èô§Â§±Ë¥•: ' + e.message);
        }
    }

    function editMapRecord() {
        if (!currentDetailRecord) return;
        closeDetailModal();
        
        // Reuse the add modal for editing
        // We need to store the editing ID
        document.getElementById('modal').dataset.editId = currentDetailRecord.id;
        document.getElementById('modal').dataset.editIndex = allRecords.findIndex(r => r.id === currentDetailRecord.id);
        
        document.getElementById('record-title').value = currentDetailRecord.title;
        document.getElementById('record-desc').value = currentDetailRecord.desc || '';
        document.getElementById('record-img').value = currentDetailRecord.image || '';
        
        // We can't easily change lat/lng in this simple modal without clicking map
        // So we assume location is fixed for now, or we could let them click map to update
        // For simplicity, let's keep location same unless they click map?
        // Actually, the add modal relies on `currentLatLng`.
        currentLatLng = { lat: currentDetailRecord.lat, lng: currentDetailRecord.lng };
        
        document.getElementById('modal').style.display = 'flex';
    }
    
    // Override saveRecord to handle edit
    const originalSaveRecord = saveRecord;
    saveRecord = async function() {
        const editId = document.getElementById('modal').dataset.editId;
        if (!editId) {
            return originalSaveRecord();
        }
        
        // Edit mode
        const title = document.getElementById('record-title').value;
        const desc = document.getElementById('record-desc').value;
        const img = document.getElementById('record-img').value;

        if (!title) {
            alert('ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
            return;
        }

        const record = {
            lat: currentLatLng.lat,
            lng: currentLatLng.lng,
            title: title,
            desc: desc,
            image: img
        };

        try {
            await ipcRenderer.invoke('update_map_record', {
                id: editId,
                index: parseInt(document.getElementById('modal').dataset.editIndex),
                record: record
            });
            
            closeModal();
            loadMapRecords();
            
            // Clear edit state
            delete document.getElementById('modal').dataset.editId;
            delete document.getElementById('modal').dataset.editIndex;
        } catch (err) {
            console.error(err);
            alert('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + err.message);
        }
    }
    
    // Override closeModal to clear edit state
    const originalCloseModal = closeModal;
    closeModal = function() {
        delete document.getElementById('modal').dataset.editId;
        delete document.getElementById('modal').dataset.editIndex;
        originalCloseModal();
    }
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const { ipcRenderer } = require('electron');
    
    // ÂàùÂßãÂåñÂú∞Âõæ (ÈªòËÆ§ÊòæÁ§∫ÂπøÂ∑û)
    const map = L.map('map').setView([23.1291, 113.2644], 11);

    // ‰ΩøÁî® È´òÂæ∑Âú∞Âõæ Áì¶ÁâáÂõæÂ±Ç
    L.tileLayer('https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        attribution: '&copy; È´òÂæ∑Âú∞Âõæ'
    }).addTo(map);

    let isAdding = false;
    let currentLatLng = null;
    let allRecords = [];
    let markers = [];
    let currentUser = null;
    let selectedImagePaths = [];

    // Icons
    const myIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    
    const otherIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    async function init() {
        try {
            const userResult = await ipcRenderer.invoke('get_current_user_profile');
            currentUser = userResult;
            loadMapRecords();
        } catch (e) { console.error(e); }
    }
    init();

    // Âä†ËΩΩÂ∑≤ÊúâËÆ∞ÂΩï
    async function loadMapRecords() {
        try {
            const records = await ipcRenderer.invoke('get_map_records');
            if (Array.isArray(records)) {
                allRecords = records;
                renderMarkers(allRecords);
            }
        } catch (e) {
            console.error("Failed to load records:", e);
        }
    }

    function renderMarkers(recordsToRender) {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        recordsToRender.forEach(record => {
            const isMine = record.is_mine;
            const icon = isMine ? myIcon : otherIcon;
            
            // Determine main image
            let mainImg = '';
            if (record.images && record.images.length > 0) mainImg = record.images[0];
            else if (record.image) mainImg = record.image;

            const popupContent = `
                <div class="custom-popup" onclick="showDetailModalById(${record.id})">
                    ${mainImg ? `<img src="${mainImg}" class="popup-img">` : ''}
                    <div class="popup-info">
                        <div class="popup-title">${record.title}</div>
                        <div class="popup-desc">${record.desc || 'Êó†ÊèèËø∞'}</div>
                        <div class="user-tag" style="font-size:12px;color:#666;margin-top:5px;display:flex;align-items:center;">
                            ${record.profiles?.avatar_url ? `<img src="${record.profiles.avatar_url}" style="width:20px;height:20px;border-radius:50%;margin-right:5px;">` : ''}
                            <span>${record.profiles?.username || 'Êú™Áü•Áî®Êà∑'}</span>
                        </div>
                        <div style="text-align:center;margin-top:5px;color:#3498db;font-size:12px;">ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                    </div>
                </div>
            `;
            const marker = L.marker([record.lat, record.lng], { icon: icon }).addTo(map).bindPopup(popupContent);
            marker.recordId = record.id;
            markers.push(marker);
        });
    }

    // Expose for popup onclick
    window.showDetailModalById = (id) => {
        const record = allRecords.find(r => r.id === id);
        if (record) showDetailModal(record);
    };

    // List View Logic
    function showRecordsList() {
        document.getElementById('records-list-container').style.display = 'flex';
        renderList(allRecords);
    }

    function hideRecordsList() {
        document.getElementById('records-list-container').style.display = 'none';
    }

    function renderList(records) {
        const container = document.getElementById('list-content');
        container.innerHTML = '';
        records.forEach(record => {
            const card = document.createElement('div');
            card.className = 'record-card';
            card.onclick = () => {
                showDetailModal(record);
            };
            
            let mainImg = '';
            if (record.images && record.images.length > 0) mainImg = record.images[0];
            else if (record.image) mainImg = record.image;
            
            const imgHtml = mainImg ? `<img src="${mainImg}">` : '<div style="width:60px;height:60px;background:#eee;border-radius:4px;flex-shrink:0;"></div>';
            
            card.innerHTML = `
                ${imgHtml}
                <div class="record-card-info">
                    <div class="record-card-title">${record.title}</div>
                    <div class="record-card-desc">${record.desc || 'Êó†ÊèèËø∞'}</div>
                    <div style="font-size:12px;color:#999;">${record.profiles?.username || 'Êú™Áü•Áî®Êà∑'}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // Detail Modal Logic
    let currentDetailRecord = null;

    async function showDetailModal(record) {
        currentDetailRecord = record;
        document.getElementById('detail-title').innerText = record.title;
        document.getElementById('detail-desc').innerText = record.desc || 'ÊöÇÊó†ÊèèËø∞';
        
        // User Info
        const userHtml = `
            <div style="display:flex;align-items:center;margin-bottom:10px;">
                ${record.profiles?.avatar_url ? `<img src="${record.profiles.avatar_url}" style="width:30px;height:30px;border-radius:50%;margin-right:10px;">` : ''}
                <span style="font-weight:bold;">${record.profiles?.username || 'Êú™Áü•Áî®Êà∑'}</span>
            </div>
        `;
        document.getElementById('detail-user').innerHTML = userHtml;

        // Images
        const gallery = document.getElementById('detail-gallery');
        gallery.innerHTML = '';
        let images = record.images || [];
        if (images.length === 0 && record.image) images = [record.image];
        
        if (images.length > 0) {
            // Main image
            document.getElementById('detail-img').src = images[0];
            document.getElementById('detail-img').onclick = () => openLightbox(images[0]);
            document.getElementById('detail-img').style.display = 'block';
            
            // Thumbnails
            images.forEach(imgUrl => {
                const thumb = document.createElement('img');
                thumb.src = imgUrl;
                thumb.className = 'gallery-thumb';
                thumb.onclick = () => {
                    document.getElementById('detail-img').src = imgUrl;
                    document.getElementById('detail-img').onclick = () => openLightbox(imgUrl);
                };
                gallery.appendChild(thumb);
            });
        } else {
            document.getElementById('detail-img').style.display = 'none';
        }
        
        const date = new Date(record.id); // Assuming ID is timestamp-ish or we have created_at
        document.getElementById('detail-meta').innerText = `ËÆ∞ÂΩïÊó∂Èó¥: ${record.created_at ? new Date(record.created_at).toLocaleString() : date.toLocaleString()}`;

        // Clear previous interactions state immediately to prevent showing old data
        document.getElementById('comments-list').innerHTML = '<div style="padding:10px;color:#999;text-align:center;">Âä†ËΩΩËØÑËÆ∫‰∏≠...</div>';
        document.getElementById('like-count').innerText = '...';
        const likeBtn = document.getElementById('like-btn');
        likeBtn.classList.remove('liked');
        likeBtn.innerHTML = 'ü§ç ÁÇπËµû';

        // Interactions
        loadInteractions(record.id);

        // Show/Hide Edit/Delete buttons based on ownership
        const isMine = record.is_mine;
        document.getElementById('btn-edit').style.display = isMine ? 'inline-block' : 'none';
        document.getElementById('btn-delete').style.display = isMine ? 'inline-block' : 'none';

        document.getElementById('detail-modal').style.display = 'flex';
    }

    async function loadInteractions(recordId) {
        const { likes, comments, is_liked } = await ipcRenderer.invoke('get_record_interactions', recordId);
        
        // Likes
        const likeBtn = document.getElementById('like-btn');
        const likeCount = document.getElementById('like-count');
        likeCount.innerText = likes;
        if (is_liked) {
            likeBtn.classList.add('liked');
            likeBtn.innerHTML = '‚ù§Ô∏è Â∑≤Ëµû';
        } else {
            likeBtn.classList.remove('liked');
            likeBtn.innerHTML = 'ü§ç ÁÇπËµû';
        }
        likeBtn.onclick = () => toggleLike(recordId);

        // Comments
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';
        
        // Get current user ID for delete button check
        let currentUserId = null;
        if (currentUser) {
             currentUserId = currentUser.id;
        }

        comments.forEach(c => {
            const div = document.createElement('div');
            div.className = 'comment-item';
            
            let deleteBtn = '';
            if (currentUserId && c.user_id === currentUserId) {
                deleteBtn = `<span class="delete-comment-btn" onclick="deleteComment(${c.id})" style="color:red; cursor:pointer; margin-left:10px; font-size:12px;">[Âà†Èô§]</span>`;
            }

            div.innerHTML = `
                <span class="comment-user">${c.profiles?.username || 'Êú™Áü•Áî®Êà∑'}:</span>
                <span class="comment-content">${c.content}</span>
                <span class="comment-time">${new Date(c.created_at).toLocaleString()}</span>
                ${deleteBtn}
            `;
            commentsList.appendChild(div);
        });
    }

    async function deleteComment(commentId) {
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü')) return;
        try {
            await ipcRenderer.invoke('delete_comment', commentId);
            if (currentDetailRecord) {
                loadInteractions(currentDetailRecord.id); // Reload comments
            }
        } catch (e) {
            alert('Âà†Èô§Â§±Ë¥•: ' + e.message);
        }
    }

    async function toggleLike(recordId) {
        try {
            await ipcRenderer.invoke('toggle_like', recordId);
            loadInteractions(recordId); // Reload
        } catch (e) { alert(e.message); }
    }

    async function addComment() {
        if (!currentDetailRecord) return;
        const input = document.getElementById('comment-input');
        const content = input.value.trim();
        if (!content) return;
        
        try {
            await ipcRenderer.invoke('add_comment', { recordId: currentDetailRecord.id, content });
            input.value = '';
            loadInteractions(currentDetailRecord.id);
        } catch (e) { alert(e.message); }
    }

    function closeDetailModal() {
        document.getElementById('detail-modal').style.display = 'none';
        currentDetailRecord = null;
    }

    function openLightbox(src) {
        const lb = document.getElementById('lightbox');
        lb.querySelector('img').src = src;
        lb.style.display = 'flex';
    }
    
    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
    }

    // ... Map Adding Logic ...
    function startAddingMode() {
        isAdding = true;
        document.getElementById('map').style.cursor = 'crosshair';
    }

    map.on('click', function(e) {
        if (!isAdding) return;
        currentLatLng = e.latlng;
        selectedImagePaths = [];
        updateImagePreview();
        document.getElementById('modal').style.display = 'flex';
        isAdding = false;
        document.getElementById('map').style.cursor = '';
    });

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        clearForm();
        editingRecordId = null;
    }

    function clearForm() {
        document.getElementById('record-title').value = '';
        document.getElementById('record-desc').value = '';
        selectedImagePaths = [];
        updateImagePreview();
    }

    async function selectImage() {
        const paths = await ipcRenderer.invoke('select-image', true); // true for multiple
        if (paths) {
            selectedImagePaths = paths;
            updateImagePreview();
        }
    }

    function updateImagePreview() {
        const container = document.getElementById('image-preview');
        container.innerHTML = '';
        if (selectedImagePaths.length === 0) {
            container.innerHTML = '<span style="color:#999;font-size:12px;">Êú™ÈÄâÊã©ÂõæÁâá</span>';
            return;
        }
        selectedImagePaths.forEach(p => {
            const img = document.createElement('img');
            img.src = p;
            img.style.width = '50px';
            img.style.height = '50px';
            img.style.objectFit = 'cover';
            img.style.marginRight = '5px';
            container.appendChild(img);
        });
    }

    let editingRecordId = null;

    async function saveRecord() {
        const title = document.getElementById('record-title').value;
        const desc = document.getElementById('record-desc').value;

        if (!title) {
            alert('ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
            return;
        }

        const record = {
            lat: currentLatLng.lat,
            lng: currentLatLng.lng,
            title: title,
            desc: desc,
            images: selectedImagePaths
        };

        try {
            if (editingRecordId) {
                await ipcRenderer.invoke('update_map_record', { 
                    id: editingRecordId, 
                    record: record 
                });
            } else {
                record.id = Date.now();
                await ipcRenderer.invoke('add_map_record', record);
            }
            loadMapRecords(); // Reload all
            closeModal();
        } catch (err) {
            console.error(err);
            alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + err.message);
        }
    }

    function filterList() {
        const query = document.getElementById('list-search-input').value.trim().toLowerCase();
        if (!query) {
            renderList(allRecords);
            return;
        }
        const filtered = allRecords.filter(r => 
            (r.title && r.title.toLowerCase().includes(query)) || 
            (r.desc && r.desc.toLowerCase().includes(query))
        );
        renderList(filtered);
    }
    
    // Locate Record from Detail
    function locateRecord() {
        if (!currentDetailRecord) return;
        const targetRecord = currentDetailRecord;
        closeDetailModal();
        hideRecordsList();
        map.setView([targetRecord.lat, targetRecord.lng], 15);
        markers.forEach(marker => {
            if (marker.recordId === targetRecord.id) {
                marker.openPopup();
            }
        });
    }
    
    // Edit/Delete stubs
    async function deleteMapRecord() {
        if (!currentDetailRecord) return;
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) return;
        try {
            await ipcRenderer.invoke('delete_map_record', { id: currentDetailRecord.id });
            closeDetailModal();
            loadMapRecords();
        } catch (e) { alert('Âà†Èô§Â§±Ë¥•: ' + e.message); }
    }
    
    function editMapRecord() {
        if (!currentDetailRecord) return;
        
        editingRecordId = currentDetailRecord.id;
        currentLatLng = { lat: currentDetailRecord.lat, lng: currentDetailRecord.lng };
        
        document.getElementById('record-title').value = currentDetailRecord.title;
        document.getElementById('record-desc').value = currentDetailRecord.desc || '';
        
        selectedImagePaths = currentDetailRecord.images || (currentDetailRecord.image ? [currentDetailRecord.image] : []);
        updateImagePreview();
        
        closeDetailModal();
        document.getElementById('modal').style.display = 'flex';
    }

    loadMapRecords();
</script>
</body>
</html>