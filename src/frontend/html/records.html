<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„è§‚é¸Ÿè®°å½•</title>
  <link rel="stylesheet" href="../css/common.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; font-weight: 600; color: #2c3e50; cursor: pointer; user-select: none; }
    th:hover { background-color: #e9ecef; }
    tr:hover { background-color: #f1f1f1; }
    tbody { display: table-row-group; }
    thead { display: table-header-group; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-box { flex: 1; max-width: 300px; margin-right: 20px; margin-bottom: 0; }
    
    .delBtn {
        background-color: #e74c3c;
        padding: 5px 10px;
        font-size: 12px;
    }
    .delBtn:hover { background-color: #c0392b; }
  </style>
</head>
<body>
    <div class="container" style="max-width: 100%;">
        
        <h1>ğŸ“ æˆ‘çš„è§‚é¸Ÿè®°å½•è¡¨</h1>

        <div class="toolbar">
            <input id="search" class="search-box" placeholder="ğŸ” æœç´¢è®°å½•...">
            <button onclick="add_records()">â• æ·»åŠ è®°å½•</button>
        </div>

        <table>
          <thead>
          <tr>
            <th data-field="time">è§‚æµ‹æ—¶é—´ â†•</th>
            <th data-field="location">åœ°ç‚¹ â†•</th>
            <th data-field="count">æ•°é‡ â†•</th>
            <th data-field="species">ç§ç±» â†•</th>
            <th data-field="gender">æ€§åˆ« â†•</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="records_body"></tbody>
        </table>
    </div>

<script>
  const { ipcRenderer } = require('electron')
  let records = []

  async function loadRecords() {
    records = await ipcRenderer.invoke('get_records')
    displayRecords(records)
  }

  function displayRecords(data) {
    const tbody = document.getElementById('records_body')
    tbody.innerHTML = ''
    data.forEach((r, idx) => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
            <td>${r.time}</td>
            <td>${r.location}</td>
            <td>${r.count}</td>
            <td>${r.species}</td>
            <td>${r.gender}</td>
            <td><button class="delBtn" data-index="${idx}">åˆ é™¤</button></td>
        `
      tbody.appendChild(tr)
    })

    // ç»™åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
    document.querySelectorAll('.delBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const index = parseInt(btn.dataset.index)
        if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            await ipcRenderer.invoke('delete_record', index)
            loadRecords()  // åˆ·æ–°è¡¨æ ¼
        }
      })
    })
  }

  // æœç´¢åŠŸèƒ½
  const searchInput = document.getElementById('search')
  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase()
    const filtered = records.filter(r =>
            r.time.toLowerCase().includes(query) ||
            r.location.toLowerCase().includes(query) ||
            r.species.toLowerCase().includes(query)
    )
    displayRecords(filtered)
  })

  // æ’åºåŠŸèƒ½
  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.field
      if(!field) return;
      const sorted = [...records].sort((a, b) => {
        if(a[field] < b[field]) return -1
        if(a[field] > b[field]) return 1
        return 0
      })
      displayRecords(sorted)
    })
  })

  // è®°å½•åŠŸèƒ½
  async function add_records(){ await ipcRenderer.invoke('open_add_record_window')}

  loadRecords()
  window.addEventListener('focus', loadRecords)
</script>
</body>
</html>

