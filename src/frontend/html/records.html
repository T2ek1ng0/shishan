<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„è§‚é¸Ÿè®°å½•</title>
  <link rel="stylesheet" href="../css/common.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; font-weight: 600; color: #2c3e50; cursor: pointer; user-select: none; }
    th:hover { background-color: #e9ecef; }
    tr:hover { background-color: #f1f1f1; }
    tbody { display: table-row-group; }
    thead { display: table-header-group; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-box { flex: 1; max-width: 300px; margin-right: 20px; margin-bottom: 0; }
    
    .delBtn {
        background-color: #e74c3c;
        padding: 5px 10px;
        font-size: 12px;
    }
    .delBtn:hover { background-color: #c0392b; }
  </style>
</head>
<body>
    <div class="container" style="max-width: 100%;">
        
        <h1>ğŸ“ æˆ‘çš„è§‚é¸Ÿè®°å½•è¡¨</h1>

        <div class="toolbar">
            <input id="search" class="search-box" placeholder="ğŸ” æœç´¢è®°å½•...">
            <button onclick="add_records()">â• æ·»åŠ è®°å½•</button>
        </div>

        <table>
          <thead>
          <tr>
            <th data-field="time">è§‚æµ‹æ—¶é—´ â†•</th>
            <th data-field="location">åœ°ç‚¹ â†•</th>
            <th data-field="count">æ•°é‡ â†•</th>
            <th data-field="species">ç§ç±» â†•</th>
            <th data-field="gender">æ€§åˆ« â†•</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="records_body"></tbody>
        </table>
    </div>

<script>
  const { ipcRenderer } = require('electron')
  let records = []

  async function loadRecords() {
    records = await ipcRenderer.invoke('get_records')
    displayRecords(records)
  }

  function displayRecords(data) {
    const tbody = document.getElementById('records_body')
    tbody.innerHTML = ''
    data.forEach((r, idx) => {
      const tr = document.createElement('tr')
      const idAttr = r.id ? `data-id="${r.id}"` : '';
      tr.innerHTML = `
            <td>${r.time}</td>
            <td>${r.location}</td>
            <td>${r.count}</td>
            <td>${r.species}</td>
            <td>${r.gender}</td>
            <td>
                <button class="editBtn" data-index="${idx}" ${idAttr}>ç¼–è¾‘</button>
                <button class="delBtn" data-index="${idx}" ${idAttr}>åˆ é™¤</button>
            </td>
        `
      tbody.appendChild(tr)
    })

    // ç»™åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
    document.querySelectorAll('.delBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const index = parseInt(btn.dataset.index)
        const id = btn.dataset.id
        if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            try {
                await ipcRenderer.invoke('delete_record', { index, id })
                loadRecords()  // åˆ·æ–°è¡¨æ ¼
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message)
            }
        }
      })
    })

    // ç»™ç¼–è¾‘æŒ‰é’®ç»‘å®šäº‹ä»¶
    document.querySelectorAll('.editBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const index = parseInt(btn.dataset.index)
        const id = btn.dataset.id
        const record = records[index]
        showEditModal(record, index, id)
      })
    })
  }

  // æœç´¢åŠŸèƒ½
  const searchInput = document.getElementById('search')
  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase()
    const filtered = records.filter(r =>
            r.time.toLowerCase().includes(query) ||
            r.location.toLowerCase().includes(query) ||
            r.species.toLowerCase().includes(query)
    )
    displayRecords(filtered)
  })

  // Edit Modal Logic
  let currentEditIndex = null
  let currentEditId = null

  function showEditModal(record, index, id) {
      currentEditIndex = index
      currentEditId = id
      
      // Create modal if not exists
      let modal = document.getElementById('edit-modal')
      if (!modal) {
          modal = document.createElement('div')
          modal.id = 'edit-modal'
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;'
          modal.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:300px;">
                <h3>ç¼–è¾‘è®°å½•</h3>
                <label>æ—¶é—´: <input id="edit-time" type="datetime-local" style="width:100%;margin-bottom:10px;"></label>
                <label>åœ°ç‚¹: <input id="edit-location" style="width:100%;margin-bottom:10px;"></label>
                <label>æ•°é‡: <input id="edit-count" type="number" style="width:100%;margin-bottom:10px;"></label>
                <label>ç§ç±»: <input id="edit-species" style="width:100%;margin-bottom:10px;"></label>
                <label>æ€§åˆ«: <input id="edit-gender" style="width:100%;margin-bottom:10px;"></label>
                <div style="text-align:right;">
                    <button onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" style="background:#3498db;color:white;">ä¿å­˜</button>
                </div>
            </div>
          `
          document.body.appendChild(modal)
      }
      
      document.getElementById('edit-time').value = record.time
      document.getElementById('edit-location').value = record.location
      document.getElementById('edit-count').value = record.count
      document.getElementById('edit-species').value = record.species
      document.getElementById('edit-gender').value = record.gender
      
      modal.style.display = 'flex'
  }

  function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none'
  }

  async function saveEdit() {
      const newRecord = {
          time: document.getElementById('edit-time').value,
          location: document.getElementById('edit-location').value,
          count: document.getElementById('edit-count').value,
          species: document.getElementById('edit-species').value,
          gender: document.getElementById('edit-gender').value
      }
      
      try {
          await ipcRenderer.invoke('update_record', { 
              id: currentEditId, 
              index: currentEditIndex, 
              record: newRecord 
          })
          closeEditModal()
          loadRecords()
      } catch (e) {
          alert('æ›´æ–°å¤±è´¥: ' + e.message)
      }
  }

  // æ’åºåŠŸèƒ½
  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.field
      if(!field) return;
      const sorted = [...records].sort((a, b) => {
        if(a[field] < b[field]) return -1
        if(a[field] > b[field]) return 1
        return 0
      })
      displayRecords(sorted)
    })
  })

  // è®°å½•åŠŸèƒ½
  async function add_records(){ await ipcRenderer.invoke('open_add_record_window')}

  loadRecords()
  window.addEventListener('focus', loadRecords)
</script>
</body>
</html>

